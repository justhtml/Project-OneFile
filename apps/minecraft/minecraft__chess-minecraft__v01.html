<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Mini Voxel World — Single Stable Chunk</title>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,'Noto Sans KR',sans-serif}
  canvas{display:block}
  #ui {position:fixed;left:0;right:0;top:0;bottom:0;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:flex-end}
  .crosshair {position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;pointer-events:none}
  .crosshair:before, .crosshair:after{content:"";position:absolute;background:rgba(255,255,255,0.9)}
  .crosshair:before{left:7px;top:0;width:2px;height:16px}
  .crosshair:after{top:7px;left:0;width:16px;height:2px}
  #hud {position:fixed;left:12px;top:12px;color:white;text-shadow:0 1px 4px rgba(0,0,0,0.6);pointer-events:auto}
  #inventory {position:fixed;left:50%;transform:translateX(-50%);bottom:12px;display:flex;gap:6px;padding:8px;background:rgba(0,0,0,0.35);border-radius:8px;pointer-events:auto;max-width:600px;justify-content:center}
  .slot {width:52px;height:48px;border-radius:6px;border:2px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:11px;text-align:center;line-height:1.1;cursor:pointer;transition:all 0.18s ease}
  .slot:hover {border-color:rgba(255,255,255,0.3);}  
  .slot.selected {outline:3px solid rgba(255,255,255,0.9);transform:scale(1.06);}  
  #debug {position:fixed;right:12px;top:12px;color:white;text-shadow:0 1px 4px rgba(255,255,255,0.6);font-size:12px;opacity:0.9}
</style>
</head>
<body>
<div id="ui">
  <div class="crosshair" aria-hidden="true"></div>
  <div id="hud" aria-hidden="false">
    <div id="status">WASD: move • QE: look • Space: jump • Shift: run</div>
    <div id="controls" style="margin-top:6px">Break: X • Place: C • Inventory: 1-9</div>
  </div>
  <div id="debug">
    <div id="chunk-info">World: single stable area</div>
    <div id="pos-info">Position: (0, 0, 0)</div>
    <div id="tris-info">Tris: 0</div>
  </div>
  <div id="inventory" role="toolbar" aria-label="Inventory">
    <div class="slot selected" data-type="1" title="Grass" id="slot-1">1<br>Grass</div>
    <div class="slot" data-type="2" title="Dirt" id="slot-2">2<br>Dirt</div>
    <div class="slot" data-type="3" title="Stone" id="slot-3">3<br>Stone</div>
    <div class="slot" data-type="4" title="Bedrock" id="slot-4">4<br>Bedrock</div>
    <div class="slot" data-type="5" title="Sand" id="slot-5">5<br>Sand</div>
    <div class="slot" data-type="6" title="Wood" id="slot-6">6<br>Wood</div>
    <div class="slot" data-type="7" title="Dark" id="slot-7">7<br>Dark</div>
    <div class="slot" data-type="8" title="Light" id="slot-8">8<br>Light</div>
    <div class="slot" data-type="9" title="Frame" id="slot-9">9<br>Frame</div>
  </div>
</div>

<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script>
/* Single stable chunk / flat terrain */

const renderer = new THREE.WebGLRenderer({
  antialias: true,
  alpha: false,
  powerPreference: "high-performance"
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
document.body.appendChild(renderer.domElement);
const scene = new THREE.Scene();
const skyGradient = new THREE.CubeTextureLoader().load([
  // You can use actual sky textures or keep it simple with color
]);
// Simple version - keep the color but add fog (step 3)
scene.background = new THREE.Color(0x87ceeb);
const camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 0.1, 500);
camera.position.set(0, 2, 5);

const ambient = new THREE.AmbientLight(0xffffff, 0.6); 
scene.add(ambient);
const sun = new THREE.DirectionalLight(0xffffff, 0.8); 
sun.position.set(20, 40, 20); 
sun.castShadow = true;
sun.shadow.mapSize.width = 2048;
sun.shadow.mapSize.height = 2048;
sun.shadow.camera.left = -50;
sun.shadow.camera.right = 50;
sun.shadow.camera.top = 50;
sun.shadow.camera.bottom = -50;
sun.shadow.camera.near = 0.5;
sun.shadow.camera.far = 100;
scene.add(sun);
const hemiLight = new THREE.HemisphereLight(0x87ceeb, 0x8b7355, 0.3);
scene.add(hemiLight);


// Enable shadows on renderer
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
});

/* World: single fixed grid */
const WORLD_W = 64; // x
const WORLD_D = 64; // z
const WORLD_H = 64; // y
const GROUND_Y = 12;
const BEDROCK_LAYERS = 3;

// Block types
const BT = {
  AIR:0, GRASS:1, DIRT:2, STONE:3, BEDROCK:4, SAND:5, WOOD:6, DARK:7, LIGHT:8, FRAME:9,
  W_PAWN:10, W_ROOK:11, W_KNIGHT:12, W_BISHOP:13, W_QUEEN:14, W_KING:15,
  B_PAWN:16, B_ROOK:17, B_KNIGHT:18, B_BISHOP:19, B_QUEEN:20, B_KING:21
};

const CHESS_PIECES = new Set([
  BT.W_PAWN,BT.W_ROOK,BT.W_KNIGHT,BT.W_BISHOP,BT.W_QUEEN,BT.W_KING,
  BT.B_PAWN,BT.B_ROOK,BT.B_KNIGHT,BT.B_BISHOP,BT.B_QUEEN,BT.B_KING
]);
const OPAQUE = new Set([BT.GRASS,BT.DIRT,BT.STONE,BT.BEDROCK,BT.SAND,BT.WOOD,BT.DARK,BT.LIGHT,BT.FRAME]);

const materials = {
  [BT.GRASS]: new THREE.MeshStandardMaterial({
    color: 0x4caf50, 
    roughness: 0.8, 
    metalness: 0.1
  }),
  [BT.DIRT]: new THREE.MeshStandardMaterial({
    color: 0x8b5a3c, 
    roughness: 0.9, 
    metalness: 0.0
  }),
  [BT.STONE]: new THREE.MeshStandardMaterial({
    color: 0x666666, 
    roughness: 0.7, 
    metalness: 0.2
  }),
  [BT.BEDROCK]: new THREE.MeshStandardMaterial({
    color: 0x2c2c2c, 
    roughness: 0.6, 
    metalness: 0.3
  }),
  [BT.SAND]: new THREE.MeshStandardMaterial({
    color: 0xf4e4bc, 
    roughness: 0.85, 
    metalness: 0.0
  }),
  [BT.WOOD]: new THREE.MeshStandardMaterial({
    color: 0x8b4513, 
    roughness: 0.8, 
    metalness: 0.0
  }),
  [BT.DARK]: new THREE.MeshStandardMaterial({
    color: 0xb58863, 
    roughness: 0.6, 
    metalness: 0.1
  }),
  [BT.LIGHT]: new THREE.MeshStandardMaterial({
    color: 0xf0d9b5, 
    roughness: 0.5, 
    metalness: 0.1
  }),
  [BT.FRAME]: new THREE.MeshStandardMaterial({
    color: 0x5c4033, 
    roughness: 0.7, 
    metalness: 0.2
  })
};

// Team colors for roles 1/2/3
const TEAM_ROLE_COLORS = {
  white: { 1: 0xffffff, 2: 0xcccccc, 3: 0x999999 },
  black: { 1: 0x111111, 2: 0x444444, 3: 0x666666 }
};
const pieceMaterials = { white:{}, black:{} };
function getPieceMaterial(team, role){
  if(!pieceMaterials[team][role]){
    const color = TEAM_ROLE_COLORS[team][role];
    pieceMaterials[team][role] = new THREE.MeshStandardMaterial({ 
      color: color,
      roughness: 0.4,
      metalness: 0.3
    });
  }
  return pieceMaterials[team][role];
}
function isWhitePiece(t){ return t>=BT.W_PAWN && t<=BT.W_KING; }
function isBlackPiece(t){ return t>=BT.B_PAWN && t<=BT.B_KING; }
function isSolidType(t){ 
  return OPAQUE.has(t);
}

const HIT_RANGE = 15;

const PIECE_SIZE = { width: 2, height: 3, depth: 2 }; // 2×2×3 world cells
const PIECE_RESOLUTION = 8; // per-cell sub-voxels -> total 16×24×16

// Derived dimensions
const RX = PIECE_SIZE.width  * PIECE_RESOLUTION;   // 16
const RY = PIECE_SIZE.height * PIECE_RESOLUTION;   // 24
const RZ = PIECE_SIZE.depth  * PIECE_RESOLUTION;  // 16

/* ===== Single-matrix builder (bottom->top Y layers) ===== */
function allocTemplate(rx=RX, ry=RY, rz=RZ){
  const t = new Array(rx);
  for(let x=0;x<rx;x++){ t[x]=new Array(ry); for(let y=0;y<ry;y++){ t[x][y]=new Uint8Array(rz); } }
  return t;
}
// layer: flat rx*rz OR 2D rz×rx OR array of rz strings len=rx
function parseLayer2D(layer, rx=RX, rz=RZ){
  const out = new Array(rz);
  if (Array.isArray(layer) && layer.length === rx*rz){
    for(let z=0; z<rz; z++){
      const row = new Array(rx);
      for(let x=0; x<rx; x++) row[x] = Number(layer[z*rx + x])|0;
      out[z] = row;
    }
  } else if (Array.isArray(layer) && layer.length === rz && Array.isArray(layer[0])){
    for(let z=0; z<rz; z++){
      if (layer[z].length !== rx) throw new Error("2D row wrong length");
      out[z] = layer[z].map(n => Number(n)|0);
    }
  } else if (Array.isArray(layer) && layer.length === rz && typeof layer[0] === 'string'){
    for(let z=0; z<rz; z++){
      if (layer[z].length !== rx) throw new Error("String row length must be rx");
      const row = new Array(rx);
      for(let x=0; x<rx; x++){
        const ch = layer[z][x];
        row[x] = (ch >= '0' && ch <= '3') ? (ch.charCodeAt(0)-48) : 0;
      }
      out[z] = row;
    }
  } else if (layer == null) {
    const row = new Array(rx).fill(0);
    for(let z=0; z<rz; z++) out[z] = row.slice();
  } else {
    throw new Error("Layer must be flat rx*rz, 2D rz×rx, or rz strings len=rx");
  }
  return out; // [z][x] -> 0..3
}
function buildTemplateFromMatrixY(matrixY, rx=RX, ry=RY, rz=RZ){
  const T = allocTemplate(rx, ry, rz);
  const writeLayer = (y, parsed)=>{
    for(let z=0; z<rz; z++) for(let x=0; x<rx; x++) T[x][y][z] = parsed[z][x] & 3;
  };
  const count = Math.min(ry, matrixY.length);
  for(let y=0; y<count; y++){
    const parsed = parseLayer2D(matrixY[y], rx, rz);
    writeLayer(y, parsed);
  }
  return T;
}

/* ===== World storage ===== */
const world = new Uint8Array(WORLD_W * WORLD_H * WORLD_D);
const chessPieceAnchors = new Map(); // "x,y,z" -> blockType
function widx(x,y,z){ return (y*WORLD_D + z)*WORLD_W + x; }
function inBounds(x,y,z){ return x>=0&&x<WORLD_W&&y>=0&&y<WORLD_H&&z>=0&&z<WORLD_D; }

/* ===== Chess Piece Templates (16×24×16 voxels) ===== */
const pawnMatrixY = [
  // y=0-1: empty
  null, null,
  // y=2–4: base
  ["0000000000000000","0000000000000000","0000111111110000","0001111111111000","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001122222211000","0011222222222100","0011222222222100","0001122222211000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  // y=5–12: stem
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001331000000","0000013333100000","0000013333100000","0000001331000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  // y=13–18: head
  ["0000000000000000","0000111111110000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0001111111111000","0011122222211100","0111222222222110","0111222222222110","0011122222211100","0001111111111000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0001111111111000","0011111111111100","0111111111111110","0111111111111110","0011111111111100","0001111111111000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0001111111111000","0011111111111100","0111111111111110","0111111111111110","0011111111111100","0001111111111000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000111111110000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0001111111111000","0001111111111000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  // y=19–21: top taper
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000000110000000","0000001111000000","0000001111000000","0000000110000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  // y=22–23: tip space
  null, null
];

const rookMatrixY = [
  null,
  null,
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000022222200000","0000122222210000","0000122222210000","0000022222200000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000022222200000","0000122222210000","0000122222210000","0000022222200000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000222222220000","0002222222222000","0002222222222000","0000222222220000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000220000220000","0002200000022000","0002200000022000","0000220000220000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  null,
  null,
  null,
  null,
  null,
  null,
];


const knightMatrixY = [
  null,
  null,
  ["0000000000000000","0000000000000000","0000111111110000","0001111111111000","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001122222211000","0011222222222100","0011222222222100","0001122222211000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000111111110000","0001111111111000","0011111111111100","0111111111111110","0111111111111110","0011111111111100","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000111111110000","0001111111111000","0011111111111100","0111133311111110","0111133311111110","0011111111111100","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  null,
  null,
  null,
  null
];

const bishopMatrixY = [
  null,
  null,
  ["0000000000000000","0000000000000000","0000111111110000","0001111111111000","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001122222211000","0011222222222100","0011222222222100","0001122222211000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000022222200000","0000222222220000","0000222222220000","0000022222200000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011133100000","0001113333311000","0011133333331100","0011133333331100","0001113333311000","0000011133100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000000110000000","0000001111000000","0000001111000000","0000001111000000","0000001111000000","0000000110000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  null,
  null,
  null,
  null
];

const queenMatrixY = [
  null,
  null,
  ["0000000000000000","0000000000000000","0000111111110000","0001111111111000","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001122222211000","0011222222222100","0011222222222100","0001122222211000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000022222200000","0000222222220000","0000222222220000","0000022222200000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011133100000","0001113333311000","0011133333331100","0011133333331100","0001113333311000","0000011133100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000133333310000","0001133333331000","0011333333331100","0011333333331100","0001133333331000","0000133333310000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000000110000000","0000001111000000","0000001111000000","0000001111000000","0000001111000000","0000000110000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  null,
  null,
  null,
  null
];

const kingMatrixY = [
  null,
  null,
  ["0000000000000000","0000000000000000","0000111111110000","0001111111111000","0001111111111000","0000111111110000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001122222211000","0011222222222100","0011222222222100","0001122222211000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000022222200000","0000222222220000","0000222222220000","0000022222200000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011133100000","0001113333311000","0011133333331100","0011133333331100","0001113333311000","0000011133100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000133333310000","0001133333331000","0011333333331100","0011333333331100","0001133333331000","0000133333310000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000011111100000","0000111111110000","0001111111111000","0011111111111100","0011111111111100","0001111111111000","0000111111110000","0000011111100000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000011111100000","0000111111110000","0000111111110000","0000011111100000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000000110000000","0000001111000000","0000001111000000","0000001111000000","0000001111000000","0000000110000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000000110000000","0000001111000000","0000011111100000","0000011111100000","0000001111000000","0000000110000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  ["0000000000000000","0000000000000000","0000001111000000","0000001111000000","0000001111000000","0000001111000000","0000001111000000","0000001111000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],
  null,
  null
];

// Build all templates
const pawnTemplate   = buildTemplateFromMatrixY(pawnMatrixY);
const rookTemplate   = buildTemplateFromMatrixY(rookMatrixY);
const knightTemplate = buildTemplateFromMatrixY(knightMatrixY);
const bishopTemplate = buildTemplateFromMatrixY(bishopMatrixY);
const queenTemplate  = buildTemplateFromMatrixY(queenMatrixY);
const kingTemplate   = buildTemplateFromMatrixY(kingMatrixY);

const PIECE_TEMPLATES = {
  pawn:   pawnTemplate,
  rook:   rookTemplate,
  knight: knightTemplate,
  bishop: bishopTemplate,
  queen:  queenTemplate,
  king:   kingTemplate
};

function getPieceInfo(blockType){
  if(!CHESS_PIECES.has(blockType)) return null;
  const team = isWhitePiece(blockType) ? 'white' : 'black';
  const idx = blockType % 10; // 0..5
  const names = ['pawn','rook','knight','bishop','queen','king'];
  return { team, template: PIECE_TEMPLATES[names[idx]] };
}

/* ===== World generation (table + board) ===== */
function createWorld(){
  for(let x=0;x<WORLD_W;x++){
    for(let z=0; z<WORLD_D; z++){
      for(let y=0; y<WORLD_H; y++){
        let t = BT.AIR;
        if(y < BEDROCK_LAYERS) t = BT.BEDROCK;
        else if(y < GROUND_Y-3) t = BT.STONE;
        else if(y < GROUND_Y) t = BT.DIRT;
        else if(y === GROUND_Y) t = BT.GRASS;
        world[widx(x,y,z)] = t;
      }
    }
  }

  const tableY = GROUND_Y + 1;
  const tableSize = 24;
  const tx0 = Math.floor(WORLD_W/2 - tableSize/2);
  const tz0 = Math.floor(WORLD_W/2 - tableSize/2);
  const tx1 = tx0 + tableSize -1;
  const tz1 = tz0 + tableSize -1;

  // Table top
  for(let x=tx0;x<=tx1;x++)
    for(let z=tz0; z<=tz1; z++)
      world[widx(x, tableY, z)] = BT.SAND;

  // Chessboard on table
  const boardSize = 20;
  const bx0 = Math.floor(WORLD_W/2 - boardSize/2);
  const bz0 = Math.floor(WORLD_W/2 - boardSize/2);
  const by  = tableY + 1; // one block above table
  const bx1 = bx0 + boardSize - 1;
  const bz1 = bz0 + boardSize - 1;

  // Outer 2-block border
  for(let x=bx0;x<=bx1;x++)
    for(let z=bz0; z<=bz1; z++){
      const border = (x - bx0 < 2) || (x > bx1 - 2) || (z - bz0 < 2) || (z > bz1 - 2);
      if (border) world[widx(x, by, z)] = BT.FRAME;
    }

  // Inner 8×8 tiles (each tile 2×2 cells)
  const innerStartX = bx0 + 2, innerStartZ = bz0 + 2;
  for (let r = 0; r < 8; r++){
    for (let c = 0; c < 8; c++){
      const isDark = (r + c) % 2 === 0;
      const blockType = isDark ? BT.DARK : BT.LIGHT;
      const sx = innerStartX + c * 2;
      const sz = innerStartZ + r * 2;
      for (let x = sx; x < sx + 2; x++)
        for (let z = sz; z < sz + 2; z++)
          world[widx(x, by, z)] = blockType;
    }
  }
}

/* ===== Mesh builder for world blocks ===== */
function pushQuad(pos, norm, uv, verts, normals, uvs, indices, baseIndex){
  for(let i=0;i<4;i++){
    verts.push(pos[i*3], pos[i*3+1], pos[i*3+2]);
    normals.push(norm[0], norm[1], norm[2]);
    uvs.push(uv[i*2], uv[i*2+1]);
  }
  indices.push(baseIndex, baseIndex+1, baseIndex+2, baseIndex, baseIndex+2, baseIndex+3);
}
const faces = {
  px(x,y,z){ return { pos:[x+1,y,z,  x+1,y+1,z,  x+1,y+1,z+1,  x+1,y,z+1], norm:[1,0,0], uv:[0,0, 0,1, 1,1, 1,0] }; },
  nx(x,y,z){ return { pos:[x,y,z+1,  x,y+1,z+1,  x,y+1,z,  x,y,z], norm:[-1,0,0], uv:[0,0, 0,1, 1,1, 1,0] }; },
  py(x,y,z){ return { pos:[x,y+1,z+1, x+1,y+1,z+1, x+1,y+1,z, x,y+1,z], norm:[0,1,0], uv:[0,0, 1,0, 1,1, 0,1] }; },
  ny(x,y,z){ return { pos:[x,y,z, x+1,y,z, x+1,y,z+1, x,y,z+1], norm:[0,-1,0], uv:[0,0, 1,0, 1,1, 0,1] }; },
  pz(x,y,z){ return { pos:[x,y,z+1, x+1,y,z+1, x+1,y+1,z+1, x,y+1,z+1], norm:[0,0,1], uv:[0,0, 1,0, 1,1, 0,1] }; },
  nz(x,y,z){ return { pos:[x+1,y,z, x,y,z, x,y+1,z, x+1,y+1,z], norm:[0,0,-1], uv:[0,0, 1,0, 1,1, 0,1] }; }
};
function shouldCull(curType, nx, ny, nz){
  if(!inBounds(nx,ny,nz)) return false;
  const nt = getVoxel(nx,ny,nz); // NOTE: chess-aware
  return isSolidType(nt);
}

const meshes = new Map();
function buildWorldMeshes(){
  // remove previous world meshes
  meshes.forEach(m=>scene.remove(m)); meshes.clear();
  const accum = new Map(); const baseIndex = new Map();

  function addFace(t, quad){
    if(!accum.has(t)){ accum.set(t,{verts:[],normals:[],uvs:[],indices:[]}); baseIndex.set(t,0); }
    const buf = accum.get(t); const b = baseIndex.get(t);
    pushQuad(quad.pos, quad.norm, quad.uv, buf.verts, buf.normals, buf.uvs, buf.indices, b);
    baseIndex.set(t, b+4);
  }

  for(let x=0;x<WORLD_W;x++)
    for(let z=0;z<WORLD_D;z++)
      for(let y=0;y<WORLD_H;y++){
        const t = world[widx(x,y,z)];
        if(t===BT.AIR) continue;
        if(!shouldCull(t, x+1,y,z)) addFace(t, faces.px(x,y,z));
        if(!shouldCull(t, x-1,y,z)) addFace(t, faces.nx(x,y,z));
        if(!shouldCull(t, x,y+1,z)) addFace(t, faces.py(x,y,z));
        if(!shouldCull(t, x,y-1,z)) addFace(t, faces.ny(x,y,z));
        if(!shouldCull(t, x,y,z+1)) addFace(t, faces.pz(x,y,z));
        if(!shouldCull(t, x,y,z-1)) addFace(t, faces.nz(x,y,z));
      }

  let tris=0;
  accum.forEach((buf,t)=>{
    if(buf.verts.length===0) return;
    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.Float32BufferAttribute(buf.verts,3));
    geo.setAttribute('normal', new THREE.Float32BufferAttribute(buf.normals,3));
    geo.setAttribute('uv', new THREE.Float32BufferAttribute(buf.uvs,2));
    geo.setIndex(buf.indices);
    geo.computeBoundingSphere();
    const mesh = new THREE.Mesh(geo, materials[t]);
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    mesh.frustumCulled=true; 
    scene.add(mesh); 
    meshes.set(t,mesh);
    tris += buf.indices.length/3;
  });
  document.getElementById('tris-info').textContent = `Tris: ${tris.toLocaleString()}`;

  // build chess piece sub-voxel meshes (adds to tris)
  buildChessPieceMeshesIntoScene();
}

/* ===== Chess sub-voxel rendering ===== */
function eachAnchor(cb){
  for(const [key,t] of chessPieceAnchors){
    const [ax,ay,az] = key.split(',').map(Number);
    cb(ax,ay,az,t);
  }
}
function pieceCellSolidAt(ax,ay,az, pieceInfo, x,y,z){
  const SUB = PIECE_RESOLUTION;
  const rx = PIECE_SIZE.width*SUB, ry = PIECE_SIZE.height*SUB, rz = PIECE_SIZE.depth*SUB;
  const lx = (x-ax)*SUB, ly=(y-ay)*SUB, lz=(z-az)*SUB;
  if(lx<0||ly<0||lz<0||lx>=rx||ly>=ry||lz>=rz) return false;
  const T = pieceInfo.template;
  for(let sx=lx; sx<lx+SUB; sx++)
    for(let sy=ly; sy<ly+SUB; sy++)
      for(let sz=lz; sz<lz+SUB; sz++)
        if(T[sx][sy][sz]!==0) return true;
  return false;
}
function buildChessPieceMeshesIntoScene(){
  // remove previous piece batches
  for(const obj of scene.children.slice()){
    if(obj.userData && obj.userData.isPieceBatch) scene.remove(obj);
  }

  const SUB = PIECE_RESOLUTION, s = 1/SUB;
  const accum = {}; // "team:role" -> buffers

  eachAnchor((ax,ay,az,type)=>{
    const info = getPieceInfo(type); if(!info) return;
    const T = info.template;
    const team = isWhitePiece(type) ? 'white' : 'black';
    const rx = PIECE_SIZE.width*SUB, ry = PIECE_SIZE.height*SUB, rz = PIECE_SIZE.depth*SUB;

    const filled = (lx,ly,lz)=> (lx>=0&&ly>=0&&lz>=0&&lx<rx&&ly<ry&&lz<rz) ? (T[lx][ly][lz]!==0) : false;

    for(let lx=0; lx<rx; lx++)
    for(let ly=0; ly<ry; ly++)
    for(let lz=0; lz<rz; lz++){
      const role = T[lx][ly][lz]; if(role===0) continue;
      const X = ax + lx*s, Y = ay + ly*s, Z = az + lz*s;
      const key = `${team}:${role}`;
      if(!accum[key]) accum[key] = { verts:[], normals:[], uvs:[], indices:[], count:0 };
      const buf = accum[key];

      const pushFace = (face)=>{
        const base = buf.count*4;
        let pos, norm;
        switch(face){
          case 'px': pos=[X+s,Y,Z, X+s,Y+s,Z, X+s,Y+s,Z+s, X+s,Y,Z+s]; norm=[1,0,0]; break;
          case 'nx': pos=[X,  Y,Z+s, X,  Y+s,Z+s, X,  Y+s,Z,   X,  Y,Z  ]; norm=[-1,0,0]; break;
          case 'py': pos=[X,  Y+s,Z+s, X+s,Y+s,Z+s, X+s,Y+s,Z, X,  Y+s,Z]; norm=[0,1,0]; break;
          case 'ny': pos=[X,  Y,  Z,   X+s,Y,  Z,   X+s,Y,  Z+s, X,  Y,  Z+s]; norm=[0,-1,0]; break;
          case 'pz': pos=[X,  Y,  Z+s, X+s,Y,  Z+s, X+s,Y+s,Z+s, X,  Y+s,Z+s]; norm=[0,0,1]; break;
          case 'nz': pos=[X+s,Y,  Z,   X,  Y,  Z,   X,  Y+s,Z,   X+s,Y+s,Z  ]; norm=[0,0,-1]; break;
        }
        const uv=[0,0,1,0,1,1,0,1];
        for(let i=0;i<4;i++){
          buf.verts.push(pos[i*3],pos[i*3+1],pos[i*3+2]);
          buf.normals.push(norm[0],norm[1],norm[2]);
          buf.uvs.push(uv[i*2],uv[i*1+1]);
        }
        buf.indices.push(base, base+1, base+2, base, base+2, base+3);
        buf.count++;
      };

if(!filled(lx+1,ly,lz)) pushFace('px');
if(!filled(lx-1,ly,lz)) pushFace('nx');
if(!filled(lx,ly+1,lz)) pushFace('py');
// Only render bottom face if not at the very bottom of the piece
if(!filled(lx,ly-1,lz) && ly > 0) pushFace('ny');
if(!filled(lx,ly,lz+1)) pushFace('pz');
if(!filled(lx,ly,lz-1)) pushFace('nz');
    }
  });

  let trisAdded = 0;
  for(const key of Object.keys(accum)){
    const [team, roleStr] = key.split(':'); const role = Number(roleStr);
    const buf = accum[key]; if(buf.indices.length===0) continue;

    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.Float32BufferAttribute(buf.verts,3));
    geo.setAttribute('normal',   new THREE.Float32BufferAttribute(buf.normals,3));
    geo.setAttribute('uv',       new THREE.Float32BufferAttribute(buf.uvs,2));
    geo.setIndex(buf.indices); geo.computeBoundingSphere();

    const mesh = new THREE.Mesh(geo, getPieceMaterial(team, role));
    mesh.userData.isPieceBatch = true; scene.add(mesh);
    trisAdded += buf.indices.length/3;
  }

  // update tris counter (add to existing)
  const trisEl = document.getElementById('tris-info');
  const prev = (trisEl.textContent.match(/\d[\d,]*/)||['0'])[0].replace(/,/g,'')|0;
  trisEl.textContent = `Tris: ${(prev + trisAdded).toLocaleString()}`;
}

/* ===== Player & physics ===== */
const player = {
  pos: new THREE.Vector3(WORLD_W/2, GROUND_Y+4, WORLD_D/2),
  velocity: new THREE.Vector3(), yaw:0, pitch:0,
  speed:8.0, runSpeed:16.0, width:1.2, height:3.6, onGround:false
};
const cameraTarget = new THREE.Vector3();

function updateCamera(){
  const eye = player.pos.clone(); 
  eye.y += player.height*0.9;
  
  // Smooth camera position (lerp)
  cameraTarget.copy(eye);
  camera.position.lerp(cameraTarget, 0.3);
  
  camera.rotation.order='YXZ';
  camera.rotation.y = player.yaw;
  camera.rotation.x = player.pitch;
}
const GRAVITY = -9.8, JUMP = 7, EPS=1e-4;
function aabbHitsBlock(px,py,pz,pw,ph,bx,by,bz){
  const pmin={x:px-pw/2,y:py,z:pz-pw/2}, pmax={x:px+pw/2,y:py+ph,z:pz+pw/2};
  const bmin={x:bx,y:by,z:bz}, bmax={x:bx+1,y:by+1,z:bz+1};
  return !(pmax.x<=bmin.x||pmin.x>=bmax.x||pmax.y<=bmin.y||pmin.y>=bmax.y||pmax.z<=bmin.z||pmin.z>=bmax.z);
}

/* ===== Chess-aware get/set ===== */
function getVoxel(x,y,z){
  if(!inBounds(x,y,z)) return BT.AIR;
  // Don't return piece types - pieces are entities, not voxels
  return world[widx(x,y,z)];
}

function setVoxel(x,y,z,t){
  if(!inBounds(x,y,z)) return;
  
  if (CHESS_PIECES.has(t)){
    // Check if 2×2×3 space is clear in WORLD (not counting other pieces)
    for (let dx=0; dx<PIECE_SIZE.width; dx++)
      for (let dy=0; dy<PIECE_SIZE.height; dy++)
        for (let dz=0; dz<PIECE_SIZE.depth; dz++){
          const cx=x+dx, cy=y+dy, cz=z+dz;
          if (!inBounds(cx,cy,cz)) return;
          // Only check world blocks, not other pieces
          if (world[widx(cx,cy,cz)] !== BT.AIR) return;
        }
    
    // Check if overlapping with another piece
    for (const [key, otherPiece] of chessPieceAnchors){
      const [ax, ay, az] = key.split(',').map(Number);
      // Check if footprints overlap
      const overlapX = !(x + PIECE_SIZE.width <= ax || x >= ax + PIECE_SIZE.width);
      const overlapY = !(y + PIECE_SIZE.height <= ay || y >= ay + PIECE_SIZE.height);
      const overlapZ = !(z + PIECE_SIZE.depth <= az || z >= az + PIECE_SIZE.depth);
      if (overlapX && overlapY && overlapZ) return; // Can't place overlapping pieces
    }
    
    chessPieceAnchors.set(`${x},${y},${z}`, t);
    console.log('Placed chess piece entity:', t, 'at', x, y, z);
    return;
  }
  
  world[widx(x,y,z)] = t;
}
function removeVoxel(x,y,z){
  if (!inBounds(x,y,z)) return;
  // remove piece if target cell is within its footprint
  for (const [anchorKey] of chessPieceAnchors){
    const [ax, ay, az] = anchorKey.split(',').map(Number);
    if (x>=ax && x<ax+PIECE_SIZE.width &&
        y>=ay && y<ay+PIECE_SIZE.height &&
        z>=az && z<az+PIECE_SIZE.depth){
      chessPieceAnchors.delete(anchorKey);
      return;
    }
  }
  world[widx(x, y, z)] = BT.AIR;
}

/* ===== Physics collisions (chess-aware) ===== */
function resolveCollisions(desired){
  const o = player.pos.clone(); const r = o.clone();
  
  function collidesAt(x,y,z){
    const minX=Math.floor(x-player.width/2)-1, maxX=Math.floor(x+player.width/2)+1;
    const minY=Math.floor(y)-1, maxY=Math.floor(y+player.height)+1;
    const minZ=Math.floor(z-player.width/2)-1, maxZ=Math.floor(z+player.width/2)+1;
    
    for(let bx=minX;bx<=maxX;bx++)
      for(let by=minY;by<=maxY;by++)
        for(let bz=minZ;bz<=maxZ;bz++){
          if(!inBounds(bx,by,bz)) continue;
          
          // Check world blocks
          const t=world[widx(bx,by,bz)];
          if(OPAQUE.has(t)){
            if(aabbHitsBlock(x,y,z,player.width,player.height,bx,by,bz)) return {bx,by,bz};
          }
          
          // Check chess piece entities
          for (const [key, pieceType] of chessPieceAnchors){
            const [ax, ay, az] = key.split(',').map(Number);
            // Check if player collides with piece footprint (2×2×3)
            for (let dx=0; dx<PIECE_SIZE.width; dx++)
              for (let dy=0; dy<PIECE_SIZE.height; dy++)
                for (let dz=0; dz<PIECE_SIZE.depth; dz++){
                  const px = ax + dx, py = ay + dy, pz = az + dz;
                  if (px === bx && py === by && pz === bz){
                    if(aabbHitsBlock(x,y,z,player.width,player.height,px,py,pz)){
                      return {bx:px, by:py, bz:pz};
                    }
                  }
                }
          }
        }
    return null;
  }
  
  if(Math.abs(desired.x-o.x)>EPS){
    const c = collidesAt(desired.x,o.y,o.z);
    if(!c) r.x=desired.x; 
    else { r.x = desired.x>o.x ? c.bx - player.width/2 - EPS : c.bx + 1 + player.width/2 + EPS; player.velocity.x=0; }
  }
  if(Math.abs(desired.y-o.y)>EPS){
    const c = collidesAt(r.x,desired.y,r.z);
    if(!c) r.y=desired.y; 
    else {
      if(desired.y>o.y){ r.y = c.by - player.height - EPS; player.velocity.y = Math.min(0,player.velocity.y);}
      else { r.y = c.by + 1 + EPS; player.velocity.y=0; player.onGround=true; }
    }
  }
  if(Math.abs(desired.z-o.z)>EPS){
    const c = collidesAt(r.x,r.y,desired.z);
    if(!c) r.z=desired.z; 
    else { r.z = desired.z>o.z ? c.bz - player.width/2 - EPS : c.bz + 1 + player.width/2 + EPS; player.velocity.z=0; }
  }
  return r;
}

/* ===== Controls ===== */
const input = {forward:false,back:false,left:false,right:false, lookLeft:false,lookRight:false,lookUp:false,lookDown:false, jump:false, break:false, place:false, run:false};
window.addEventListener('keydown', (e)=>{
  if(e.repeat) return;
  switch(e.code){
    case 'KeyW': input.forward=true; break;
    case 'KeyS': input.back=true; break;
    case 'KeyA': input.left=true; break;
    case 'KeyD': input.right=true; break;
    case 'ArrowLeft': input.lookLeft=true; break;
    case 'ArrowRight': input.lookRight=true; break;
    case 'ArrowUp': input.lookUp=true; break;
    case 'ArrowDown': input.lookDown=true; break;
    case 'Space': input.jump=true; break;
    case 'ShiftLeft': case 'ShiftRight': input.run=true; break;
    case 'KeyX': input.break=true; break;
    case 'KeyC': input.place=true; break;
    
    // Number keys select from current inventory mode
    case 'Digit1': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[0]) setSelectedType(data[0].t);
      break;
    }
    case 'Digit2': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[1]) setSelectedType(data[1].t);
      break;
    }
    case 'Digit3': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[2]) setSelectedType(data[2].t);
      break;
    }
    case 'Digit4': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[3]) setSelectedType(data[3].t);
      break;
    }
    case 'Digit5': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[4]) setSelectedType(data[4].t);
      break;
    }
    case 'Digit6': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[5]) setSelectedType(data[5].t);
      break;
    }
    case 'Digit7': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[6]) setSelectedType(data[6].t);
      break;
    }
    case 'Digit8': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[7]) setSelectedType(data[7].t);
      break;
    }
    case 'Digit9': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[8]) setSelectedType(data[8].t);
      break;
    }
    case 'Digit0': {
      const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
      if (data[9]) setSelectedType(data[9].t);
      break;
    }
    
    case 'KeyV':
      inventoryMode = (inventoryMode==='blocks') ? 'chess' : 'blocks';
      renderInventory();
      console.log('Switched to:', inventoryMode); // DEBUG
      break;
  }
});
window.addEventListener('keyup', (e)=>{
  switch(e.code){
    case 'KeyW': input.forward=false; break;
    case 'KeyS': input.back=false; break;
    case 'KeyA': input.left=false; break;
    case 'KeyD': input.right=false; break;
    case 'ArrowLeft': input.lookLeft=false; break;
    case 'ArrowRight': input.lookRight=false; break;
    case 'ArrowUp': input.lookUp=false; break;
    case 'ArrowDown': input.lookDown=false; break;
    case 'Space': input.jump=false; break;
    case 'ShiftLeft': case 'ShiftRight': input.run=false; break;
    case 'KeyX': input.break=false; break;
    case 'KeyC': input.place=false; break;
  }
});

let selectedType = 1;

function setSelectedType(t){
  selectedType = t;
  const slots = document.querySelectorAll('.slot');
  slots.forEach(s=> s.classList.toggle('selected', Number(s.dataset.type)===t));
  console.log('Selected type:', t, 'Is chess piece:', CHESS_PIECES.has(t)); // DEBUG
}

// Re-attach click listeners whenever inventory changes
function attachSlotListeners(){
  const slots = document.querySelectorAll('.slot');
  slots.forEach(s=> {
    s.replaceWith(s.cloneNode(true)); // Remove old listeners
  });
  document.querySelectorAll('.slot').forEach(s=> {
    s.addEventListener('click', ()=> setSelectedType(Number(s.dataset.type)));
  });
}

/* ===== Inventory toggle (V) ===== */
let inventoryMode = 'blocks'; // 'blocks' | 'chess'
const blockSlots = [
  {t:BT.GRASS, name:'Grass'},{t:BT.DIRT,name:'Dirt'},{t:BT.STONE,name:'Stone'},
  {t:BT.BEDROCK,name:'Bedrock'},{t:BT.SAND,name:'Sand'},{t:BT.WOOD,name:'Wood'},
  {t:BT.DARK,name:'Dark'},{t:BT.LIGHT,name:'Light'},{t:BT.FRAME,name:'Frame'},
];
const chessSlots = [
  {t:BT.W_PAWN, name:'W Pawn'},{t:BT.W_ROOK, name:'W Rook'},{t:BT.W_KNIGHT, name:'W Knight'},
  {t:BT.W_BISHOP,name:'W Bishop'},{t:BT.W_QUEEN,name:'W Queen'},{t:BT.W_KING,name:'W King'},
  {t:BT.B_PAWN, name:'B Pawn'},{t:BT.B_ROOK, name:'B Rook'},{t:BT.B_KNIGHT, name:'B Knight'},
];
function renderInventory(){
  const data = (inventoryMode==='blocks') ? blockSlots : chessSlots;
  const container = document.getElementById('inventory');
  
  // Clear and rebuild slots
  container.innerHTML = '';
  
  data.forEach((it, i) => {
    const slot = document.createElement('div');
    slot.className = 'slot';
    slot.dataset.type = it.t;
    slot.title = it.name;
    slot.id = `slot-${i+1}`;
    
    // Add visual styling for chess pieces
    if (CHESS_PIECES.has(it.t)) {
      if (isWhitePiece(it.t)) {
        slot.style.background = 'rgba(240,240,240,0.2)';
      } else {
        slot.style.background = 'rgba(51,51,51,0.4)';
        slot.style.color = '#fff';
      }
    }
    
    slot.innerHTML = `${i+1}<br>${it.name}`;
    
    // Add click listener
    slot.addEventListener('click', () => setSelectedType(it.t));
    
    // Highlight if selected
    if (it.t === selectedType) {
      slot.classList.add('selected');
    }
    
    container.appendChild(slot);
  });
  
  document.getElementById('controls').textContent =
    `Break: X • Place: C • Inventory: 1-9 • Toggle: V (${inventoryMode})`;
  
  console.log('Inventory mode:', inventoryMode, 'Slots:', data.map(d => d.t)); // DEBUG
}
renderInventory();

/* ===== Raycast & interaction ===== */
function getCameraDir(){ const dir = new THREE.Vector3(0,0,-1); dir.applyQuaternion(camera.quaternion); return dir; }
function ddaRaycast(maxDist=6){
  const origin = camera.position.clone();
  let x=Math.floor(origin.x), y=Math.floor(origin.y), z=Math.floor(origin.z);
  const dir = getCameraDir();
  const stepX = dir.x>0?1:-1, stepY = dir.y>0?1:-1, stepZ = dir.z>0?1:-1;
  const txDelta = dir.x!==0? Math.abs(1/dir.x): Infinity;
  const tyDelta = dir.y!==0? Math.abs(1/dir.y): Infinity;
  const tzDelta = dir.z!==0? Math.abs(1/dir.z): Infinity;
  const frac = (v)=> v - Math.floor(v);
  let txMax = dir.x>0 ? (1-frac(origin.x))*txDelta : frac(origin.x)*txDelta;
  let tyMax = dir.y>0 ? (1-frac(origin.y))*tyDelta : frac(origin.y)*tyDelta;
  let tzMax = dir.z>0 ? (1-frac(origin.z))*tzDelta : frac(origin.z)*tzDelta;
  const maxSteps = Math.ceil(maxDist / Math.min(txDelta,tyDelta,tzDelta));
  let faceNormal = new THREE.Vector3();
  for(let i=0;i<maxSteps;i++){
    const t = getVoxel(x,y,z);
    if(t!==BT.AIR){ return {x,y,z, type:t, normal:faceNormal.clone()}; }
    if(txMax < tyMax){
      if(txMax < tzMax){ x += stepX; txMax += txDelta; faceNormal.set(-stepX,0,0); }
      else { z += stepZ; tzMax += tzDelta; faceNormal.set(0,0,-stepZ); }
    } else {
      if(tyMax < tzMax){ y += stepY; tyMax += tyDelta; faceNormal.set(0,-stepY,0); }
      else { z += stepZ; tzMax += tzDelta; faceNormal.set(0,0,-stepZ); }
    }
  }
  return null;
}
function performBreak(){
  const hit = ddaRaycast(HIT_RANGE); if(!hit) return;
  if(hit.type === BT.BEDROCK) return;
  removeVoxel(hit.x,hit.y,hit.z);
  buildWorldMeshes();
}
function performPlace(){
  const hit = ddaRaycast(HIT_RANGE); if(!hit) return;
  let nx = hit.x + hit.normal.x;
  let ny = hit.y + hit.normal.y;
  let nz = hit.z + hit.normal.z;
  
  // For chess pieces, special handling
  if (CHESS_PIECES.has(selectedType)) {
    // Place one block above the surface
    if (hit.normal.y > 0) {
      ny = hit.y + 1;
    }
    
    // Snap to even coordinates (2×2 grid alignment)
    nx = Math.floor(nx / 2) * 2;
    nz = Math.floor(nz / 2) * 2;
    
    // Check player collision with 2×2×3 space
    for (let dx = 0; dx < PIECE_SIZE.width; dx++) {
      for (let dy = 0; dy < PIECE_SIZE.height; dy++) {
        for (let dz = 0; dz < PIECE_SIZE.depth; dz++) {
          const checkX = nx + dx, checkY = ny + dy, checkZ = nz + dz;
          if (!inBounds(checkX, checkY, checkZ)) return;
        }
      }
    }
  } else {
    // Regular blocks
    if(aabbHitsBlock(player.pos.x,player.pos.y,player.pos.z,player.width,player.height, nx,ny,nz)) return;
    if(world[widx(nx,ny,nz)]!==BT.AIR) return;
  }
  
  setVoxel(nx,ny,nz, selectedType);
  buildWorldMeshes();
}

function getAOFactor(x, y, z, nx, ny, nz) {
  // Count how many solid neighbors this face has
  let count = 0;
  const checks = [
    [nx+1, ny, nz], [nx-1, ny, nz],
    [nx, ny+1, nz], [nx, ny-1, nz],
    [nx, ny, nz+1], [nx, ny, nz-1]
  ];
  
  for (const [cx, cy, cz] of checks) {
    if (!inBounds(cx, cy, cz)) continue;
    const t = world[widx(cx, cy, cz)];
    if (OPAQUE.has(t)) count++;
  }
  
  return 1.0 - (count * 0.08); // Darken based on neighbors
}

// --- Target highlight box ---
const boxEdgesGeo = new THREE.EdgesGeometry(new THREE.BoxGeometry(1.002, 1.002, 1.002));
const breakBox = new THREE.LineSegments(boxEdgesGeo,new THREE.LineBasicMaterial({ color: 0xff4444 }));
breakBox.visible = false; breakBox.renderOrder = 999; breakBox.material.depthTest = false; scene.add(breakBox);

/* ===== Update loop ===== */
let last = performance.now();
function update(dt){
  const lookSpeed = 1.5;
  
  // Look controls with proper clamping
  if(input.lookLeft)  player.yaw += lookSpeed*dt;
  if(input.lookRight) player.yaw -= lookSpeed*dt;
  
  // Clamp pitch to prevent flipping
  if(input.lookUp) {
    player.pitch += lookSpeed*dt;
    player.pitch = Math.min(Math.PI/2 - 0.01, player.pitch); // Max look up
  }
  if(input.lookDown) {
    player.pitch -= lookSpeed*dt;
    player.pitch = Math.max(-Math.PI/2 + 0.01, player.pitch); // Max look down
  }

  const f = (input.forward?1:0) - (input.back?1:0);
  const s = (input.right?1:0) - (input.left?1:0);
  let mag = Math.hypot(f,s), lx=0,lz=0;
  if(mag>0){ const sp = input.run?player.runSpeed:player.speed; lx=(s/mag)*sp; lz=(f/mag)*sp; }
  const sy=Math.sin(player.yaw), cy=Math.cos(player.yaw);
  player.velocity.x = lx*cy - lz*sy;
  player.velocity.z = -lx*sy - lz*cy;
  if(input.jump && player.onGround){ player.velocity.y = JUMP; player.onGround=false; }
  player.velocity.y += GRAVITY*dt;

  const desired = player.pos.clone().addScaledVector(player.velocity, dt);
  player.onGround=false;
  const resolved = resolveCollisions(desired);
  player.pos.copy(resolved);
  // Respawn if falling too far
  if(player.pos.y < -20){ 
    player.pos.set(WORLD_W/2, GROUND_Y+4, WORLD_D/2); 
    player.velocity.set(0,0,0);
    player.yaw = 0;
    player.pitch = 0;
  }

  // Add world boundaries (prevent walking off edges)
  player.pos.x = Math.max(1, Math.min(WORLD_W - 1, player.pos.x));
  player.pos.z = Math.max(1, Math.min(WORLD_D - 1, player.pos.z));

  if(input.break && !input._break){ performBreak(); input._break=true; }
  if(!input.break) input._break=false;
  if(input.place && !input._place){ performPlace(); input.  _place=true; }
  if(!input.place) input._place=false;

  document.getElementById('pos-info').textContent =
    `Position: (${Math.floor(player.pos.x)}, ${Math.floor(player.pos.y)}, ${Math.floor(player.pos.z)})`;

  // highlight
  const hit = ddaRaycast(HIT_RANGE);
  breakBox.visible = !!hit;
  if (hit) breakBox.position.set(hit.x + 0.5, hit.y + 0.5, hit.z + 0.5);

  updateCamera();
}
function animate(t){
  const dt = Math.min(0.05, (t-last)/1000); last=t;
  update(dt);
  renderer.render(scene,camera);
  requestAnimationFrame(animate);
}

/* ===== Init ===== */
createWorld();
buildWorldMeshes();
updateCamera();
requestAnimationFrame(animate);
</script>
</body>
</html>